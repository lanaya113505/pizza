<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chrome File System Access Demo</title>
  <style>
    :root { --pad: 14px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0b0d12; color: #e6ebf2; }
    header { padding: var(--pad); background: #111522; border-bottom: 1px solid #242a3a; position: sticky; top: 0; z-index: 1; }
    h1 { margin: 0; font-size: 18px; font-weight: 700; }
    main { display: grid; grid-template-columns: 360px 1fr; gap: 16px; padding: 16px; }
    .panel { background: #0f1320; border: 1px solid #1f2740; border-radius: 14px; box-shadow: 0 8px 30px rgba(0,0,0,.25); overflow: hidden; }
    .panel h2 { font-size: 14px; letter-spacing: .3px; padding: 12px 14px; margin: 0; background: #121831; border-bottom: 1px solid #1c2240; }
    .panel .content { padding: 14px; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    button, input, select, textarea { font: inherit; color: inherit; }
    button { padding: 10px 12px; border-radius: 10px; background: #1a2348; border: 1px solid #2a3568; cursor: pointer; }
    button:hover { background: #222d5a; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    input[type="text"] { background: #0e1326; border: 1px solid #27305c; padding: 10px; border-radius: 10px; width: 100%; }
    textarea { background: #0e1326; border: 1px solid #27305c; padding: 10px; border-radius: 10px; width: 100%; min-height: 120px; resize: vertical; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background: #0a0f22; border: 1px dashed #2a3568; border-radius: 10px; padding: 10px; min-height: 84px; white-space: pre-wrap; }
    ul#listing { list-style: none; padding: 0; margin: 0; }
    ul#listing li { padding: 8px 10px; border-bottom: 1px solid #1b2241; display: flex; justify-content: space-between; gap: 10px; align-items: center; }
    .badge { font-size: 12px; padding: 2px 8px; border-radius: 999px; background: #1f2a52; border: 1px solid #33427a; }
    iframe#user-sandbox { width: 100%; height: 420px; border: 0; background: #0d1124; }
    .footer-note { opacity: .8; font-size: 12px; margin-top: 8px; }
  </style>
</head>
<body>
  <header>
    <h1>Chrome File System Access Demo (dengan snippet kamu di bawah)</h1>
  </header>

  <main>
    <!-- Sidebar: File System Controls -->
    <section class="panel" id="controls">
      <h2>Aksi File System</h2>
      <div class="content">
        <div class="row" style="margin-bottom:8px">
          <button id="pickDir">üìÅ Pilih Folder</button>
          <span id="folderName" class="badge">Belum dipilih</span>
        </div>

        <div class="row" style="margin-bottom:8px">
          <input id="newFileName" type="text" placeholder="Nama file, misal: demo.txt" />
          <button id="createFile">‚ûï Buat & Tulis</button>
        </div>

        <div style="margin-bottom:8px">
          <textarea id="fileContents" placeholder="Isi file yang akan disimpan..."></textarea>
        </div>

        <div class="row" style="margin-bottom:12px">
          <input id="newFolderName" type="text" placeholder="Nama folder, misal: data" />
          <button id="createFolder">üìÇ Buat Folder</button>
        </div>

        <div class="row" style="margin-bottom:12px">
          <button id="openFile">üìÑ Buka File‚Ä¶</button>
          <button id="saveAs">üíæ Save As‚Ä¶</button>
        </div>

        <div class="row">
          <button id="refreshList">üîÑ Muat Ulang Listing</button>
        </div>

        <p class="footer-note">Butuh Chrome/Edge terbaru & context aman (https:// atau <code>localhost</code>).</p>
      </div>
    </section>

    <!-- Main: Directory Listing + Logs + Snippet -->
    <section class="panel" id="workspace">
      <h2>Folder Terpilih</h2>
      <div class="content">
        <ul id="listing"></ul>
        <div class="log" id="log"></div>
      </div>
    </section>

    <section class="panel" style="grid-column: 1 / -1">
      <h2>Sandbox: Snippet HTML yang kamu kirim</h2>
      <div class="content">
        <iframe id="user-sandbox" sandbox="allow-scripts"></iframe>
        <p class="footer-note">Snippet ini disisipkan via <code>iframe.srcdoc</code> agar terisolasi dari app utama.</p>
      </div>
    </section>
  </main>

  <!-- Simpan snippet kamu apa adanya, lalu injeksikan ke iframe.srcdoc via JS agar aman dari konflik tag <html>/<head>/<body>. -->
  <textarea id="user-snippet-raw" style="display:none">&lt;html&gt;

&lt;head&gt;
    &lt;style&gt;
        u {
            container-type: inline-size;
            border-bottom-right-radius: 42%;
            float: left;
            overscroll-behavior-x: none;
        }

        meter {
            padding-left: 2048.0vmin;
        }
    &lt;/style&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;meter id=&quot;node2&quot;
        style=&quot;list-style-type: square; padding-right: inherit; float: right; offset-position: auto; grid-template-rows: none;&quot;&gt;
        &lt;bdo aria-multiline=&quot;false&quot; aria-readonly=&quot;false&quot; aria-disabled=&quot;false&quot; autocapitalize=&quot;off&quot;
            aria-live=&quot;assertive&quot; role=&quot;dialog&quot; tabindex=&quot;140&quot; aria-hidden=&quot;false&quot; aria-busy=&quot;false&quot;
            aria-checked=&quot;false&quot;
            style=&quot;animation-composition: accumulate, replace; direction: rtl; clip-path: fill-box; flood-color: Magenta; border-image-slice: 4;&quot;&gt;
        &lt;/bdo&gt;
        &lt;embed dir=&quot;rtl&quot; inert=&quot;false&quot; spellcheck=&quot;false&quot;
            style=&quot;font-variant-east-asian: full-width; scroll-margin-inline-end: 899vmax; border-bottom-style: double; object-view-box: none; scroll-behavior: auto; border-collapse: separate;&quot;&gt;
        &lt;/embed&gt;
        &lt;kbd aria-relevant=&quot;text&quot; aria-disabled=&quot;true&quot; aria-haspopup=&quot;grid&quot; aria-multiselectable=&quot;true&quot;
            draggable=&quot;true&quot; aria-atomic=&quot;false&quot; inert=&quot;true&quot; aria-orientation=&quot;undefined&quot; tabindex=&quot;3&quot;
            aria-dropeffect=&quot;copy&quot; autocapitalize=&quot;off&quot; aria-modal=&quot;false&quot; aria-pressed=&quot;true&quot; dir=&quot;ltr&quot;
            style=&quot;background-color: currentcolor; font-kerning: normal; perspective-origin: -127.0vmin; scroll-margin-inline-start: unset; margin-right: 16%; letter-spacing: 127.49533vmax; border-right-width: thin;&quot;&gt;
            &lt;b aria-relevant=&quot;removals&quot; dir=&quot;ltr&quot;
                style=&quot;border-left-color: hsl(3520716515.4380174 none 18%); object-fit: fill; flood-color: hsl(1777820452.149175 43% 60% / 63%); font-variant-numeric: ordinal; baseline-shift: super; border-top-right-radius: -1005.0ch; background-attachment: scroll; opacity: 16; border-collapse: collapse;&quot;&gt;
                &lt;select spellcheck=&quot;true&quot;&gt;
                &lt;/select&gt;
                &lt;u spellcheck=&quot;false&quot; aria-readonly=&quot;true&quot; aria-sort=&quot;descending&quot; aria-pressed=&quot;true&quot;&gt;
                &lt;/u&gt;
                &lt;i tabindex=&quot;2&quot;
                    style=&quot;padding-left: 3.3055pt; padding-top: 256vw; letter-spacing: 421vh;&quot;&gt;
                &lt;/i&gt;
                &lt;wbr aria-pressed=&quot;mixed&quot; aria-checked=&quot;undefined&quot; aria-sort=&quot;ascending&quot; itemscope=&quot;false&quot; aria-orientation=&quot;horizontal&quot; aria-required=&quot;true&quot;&gt;
                &lt;/wbr&gt;
            &lt;/b&gt;
            &lt;button aria-grabbed=&quot;true&quot;
                style=&quot;display: inline-flex; background-size: auto; container-type: normal; marker-mid: none; cx: 1854vmin; grid-template-columns: none; font-style: italic; initial-letter: drop;&quot;&gt;
                &lt;del autofocus=&quot;false&quot;
                    style=&quot;border-bottom-left-radius: -77%; direction: ltr; padding-right: 127rem; margin-bottom: -65%; animation-play-state: running; outline-offset: 1047rem; left: 5.0in; math-shift: compact; fill-rule: evenodd;&quot;&gt;
                &lt;/del&gt;
                &lt;i translate=&quot;no&quot; aria-readonly=&quot;true&quot; draggable=&quot;false&quot; tabindex=&quot;122&quot;
                    aria-grabbed=&quot;true&quot; aria-pressed=&quot;undefined&quot; enterkeyhint=&quot;search&quot; autofocus=&quot;false&quot;
                    autocapitalize=&quot;characters&quot; aria-orientation=&quot;undefined&quot; aria-current=&quot;location&quot;
                    aria-required=&quot;true&quot; aria-relevant=&quot;text&quot; spellcheck=&quot;true&quot;
                    style=&quot;list-style-position: outside; background-color: Olive; background-size: 1442vmax; border-top-left-radius: 80%; font-weight: normal; list-style-image: none; letter-spacing: normal;&quot;&gt;
                &lt;/i&gt;
                &lt;ins aria-hidden=&quot;undefined&quot; enterkeyhint=&quot;send&quot; virtualkeyboardpolicy=&quot;manual&quot;
                    dir=&quot;ltr&quot; translate=&quot;yes&quot; aria-current=&quot;false&quot; aria-orientation=&quot;vertical&quot; aria-disabled=&quot;false&quot;
                    aria-invalid=&quot;spelling&quot;
                    style=&quot;scroll-margin-right: revert-layer; font-weight: 2; border-bottom-color: MediumSpringGreen;&quot;&gt;
                &lt;/ins&gt;
                &lt;code 
                    style=&quot;border-top-color: rgb(149, 172, 157); field-sizing: content; resize: block; border-image-source: none; lighting-color: currentcolor;&quot;&gt;
          &lt;/code&gt;
            &lt;/button&gt;
        &lt;/kbd&gt;
    &lt;/meter&gt;
    &lt;progress aria-pressed=&quot;false&quot; inert=&quot;false&quot;
        style=&quot;overflow-clip-margin: border-box; text-orientation: sideways; font-optical-sizing: auto;&quot;&gt;
        &lt;i role=&quot;complementary&quot;&gt;
            &lt;ruby draggable=&quot;false&quot; inputmode=&quot;tel&quot; aria-hidden=&quot;undefined&quot; contenteditable=&quot;false&quot;
                style=&quot;filter: none; marker-end: none; border-image-repeat: stretch; flood-color: currentcolor; clip-rule: nonzero;&quot;&gt;
                &lt;code aria-autocomplete=&quot;inline&quot; tabindex=&quot;7&quot; itemscope=&quot;false&quot; aria-haspopup=&quot;true&quot;
                    style=&quot;flex-grow: 1444; background-color: currentcolor; position: fixed;&quot;&gt;
          &lt;/code&gt;
                &lt;embed aria-multiline=&quot;false&quot; aria-sort=&quot;none&quot; aria-dropeffect=&quot;execute&quot;
                    style=&quot;font-variant-caps: small-caps; border-image-outset: -255Q; font-optical-sizing: none; border-bottom-style: inset; transition-delay: +32767ms; font-variant-ligatures: normal;&quot;&gt;
                &lt;/embed&gt;
                &lt;abbr dir=&quot;rtl&quot;&gt;
                &lt;/abbr&gt;
            &lt;/ruby&gt;
            &lt;iframe 
                style=&quot;color-rendering: auto; background-size: cover; min-width: 93%; grid-auto-rows: 8%;&quot;&gt;
            &lt;/iframe&gt;
            &lt;ins aria-autocomplete=&quot;both&quot; aria-relevant=&quot;additions&quot;&gt;
            &lt;/ins&gt;
        &lt;/i&gt;
    &lt;/progress&gt;
    
    &lt;b&gt;
        &lt;u&gt;
            &lt;var&gt;
                &lt;div id=&quot;node0&quot;&gt;&lt;/div&gt;
            &lt;/var&gt;
        &lt;/u&gt;
        &lt;script&gt;
            node2.style.setProperty(&quot;margin-block-end&quot;, &quot;54%&quot;, &quot;&quot;)
        &lt;/script&gt;
        &lt;em dir=&quot;rtl&quot;
            style=&quot;color-interpolation-filters: auto; overflow-y: clip; font-size: 49%; list-style-type: disclosure-open;&quot;&gt;
            &lt;i style=&quot;filter: none; min-height: 5Q; math-depth: 1222; border-top-style: dotted; background-blend-mode: normal;&quot;&gt;
                &lt;select style=&quot;paint-order: stroke; padding-right: 1319.0vmax; box-sizing: border-box; cy: 127.0pc; fill-opacity: 707; offset-anchor: auto; border-top-width: -3.47125vmin;&quot;&gt;
                &lt;/select&gt;
            &lt;/i&gt;
            &lt;bdi aria-invalid=&quot;true&quot; style=&quot;cy: -92%; padding-left: unset; box-sizing: content-box;&quot;&gt;
                &lt;audio style=&quot;list-style-type: disclosure-closed; animation-name: none; border-image-slice: -33%; baseline-source: first; border-image-source: linear-gradient(rgb(183, 182, 114) 85%, rgb(236, 222, 108) 99% 35%, Moccasin 86%); contain-intrinsic-width: none; border-right-style: double;&quot;&gt;
                &lt;/audio&gt;
            &lt;/bdi&gt;
            &lt;datalist style=&quot;lighting-color: #e929f7; font-synthesis-weight: none; font-feature-settings: normal; break-inside: avoid-page;&quot;&gt;
            &lt;/datalist&gt;
        &lt;/em&gt;
        &lt;sub style=&quot;break-inside: avoid; grid-column-start: auto; backdrop-filter: none; writing-mode: vertical-lr; outline-color: Olive; line-height: normal; scroll-behavior: auto; contain-intrinsic-width: none; contain-intrinsic-height: none;&quot;&gt;

            &lt;/sub&gt;
        &lt;video&gt;&lt;/video&gt;
        &lt;button&gt;
            &lt;meter&gt;
                &lt;div id=&quot;node1&quot;&gt;
                &lt;/div&gt;
            &lt;/meter&gt;
        &lt;/button&gt;
    &lt;/b&gt;
    &lt;script&gt;
        node0.remove();
        node1.startViewTransition();
    &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;</textarea>

  <script>
    // ==== File System Access Demo ====
    let dirHandle = null;

    const logEl = document.getElementById('log');
    const listingEl = document.getElementById('listing');
    const folderBadge = document.getElementById('folderName');

    function log(msg, isError = false) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      if (isError) console.error(msg); else console.log(msg);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function fsSupported() {
      return !!(window.showOpenFilePicker && window.showSaveFilePicker && window.showDirectoryPicker);
    }

    async function ensureWritePermission(handle) {
      if (!handle) return false;
      if ((await handle.queryPermission({ mode: 'readwrite' })) === 'granted') return true;
      const result = await handle.requestPermission({ mode: 'readwrite' });
      return result === 'granted';
    }

    async function pickDirectory() {
      try {
        dirHandle = await window.showDirectoryPicker();
        folderBadge.textContent = dirHandle.name || '(Folder)';
        log('Folder dipilih: ' + dirHandle.name);
        await listEntries();
      } catch (e) {
        if (e && e.name === 'AbortError') return; // user cancelled
        log('Gagal memilih folder: ' + e.message, true);
      }
    }

    async function listEntries() {
      listingEl.innerHTML = '';
      if (!dirHandle) { listingEl.innerHTML = '<li>Pilih folder dulu.</li>'; return; }
      let count = 0;
      for await (const [name, handle] of dirHandle.entries()) {
        count++;
        const li = document.createElement('li');
        const type = handle.kind === 'directory' ? 'DIR' : 'FILE';
        const left = document.createElement('span');
        left.textContent = name;
        const right = document.createElement('span');
        right.className = 'badge';
        right.textContent = type;
        li.appendChild(left);
        li.appendChild(right);
        if (handle.kind === 'file') {
          li.style.cursor = 'pointer';
          li.title = 'Klik untuk membuka file';
          li.addEventListener('click', async () => {
            try {
              const file = await handle.getFile();
              const text = await file.text();
              log(`Buka ${name} (size ${file.size} bytes)`);
              document.getElementById('fileContents').value = text;
              document.getElementById('newFileName').value = name;
            } catch (e) { log('Gagal membaca: ' + e.message, true); }
          });
        }
        listingEl.appendChild(li);
      }
      log(`Listing selesai: ${count} entri.`);
    }

    async function createFolder() {
      if (!dirHandle) return log('Pilih folder dulu.', true);
      const name = (document.getElementById('newFolderName').value || '').trim();
      if (!name) return log('Nama folder kosong.', true);
      try {
        if (!await ensureWritePermission(dirHandle)) return log('Izin tulis ditolak.', true);
        await dirHandle.getDirectoryHandle(name, { create: true });
        log('Folder dibuat: ' + name);
        document.getElementById('newFolderName').value = '';
        await listEntries();
      } catch (e) { log('Gagal buat folder: ' + e.message, true); }
    }

    async function createFile() {
      if (!dirHandle) return log('Pilih folder dulu.', true);
      const name = (document.getElementById('newFileName').value || '').trim();
      const contents = document.getElementById('fileContents').value ?? '';
      if (!name) return log('Nama file kosong.', true);
      try {
        if (!await ensureWritePermission(dirHandle)) return log('Izin tulis ditolak.', true);
        const fileHandle = await dirHandle.getFileHandle(name, { create: true });
        const writable = await fileHandle.createWritable();
        await writable.write(contents);
        await writable.close();
        log('File ditulis: ' + name);
        await listEntries();
      } catch (e) { log('Gagal tulis file: ' + e.message, true); }
    }

    async function openFilePicker() {
      try {
        const [handle] = await window.showOpenFilePicker();
        const file = await handle.getFile();
        const text = await file.text();
        document.getElementById('fileContents').value = text;
        document.getElementById('newFileName').value = file.name;
        log('File dibuka: ' + file.name);
      } catch (e) {
        if (e && e.name === 'AbortError') return;
        log('Gagal buka file: ' + e.message, true);
      }
    }

    async function saveAsPicker() {
      try {
        const handle = await window.showSaveFilePicker({ suggestedName: 'example.txt' });
        const writable = await handle.createWritable();
        await writable.write(document.getElementById('fileContents').value || '');
        await writable.close();
        log('Tersimpan via Save As: ' + handle.name);
      } catch (e) {
        if (e && e.name === 'AbortError') return;
        log('Gagal Save As: ' + e.message, true);
      }
    }

    // Bind UI
    document.getElementById('pickDir').addEventListener('click', pickDirectory);
    document.getElementById('createFolder').addEventListener('click', createFolder);
    document.getElementById('createFile').addEventListener('click', createFile);
    document.getElementById('openFile').addEventListener('click', openFilePicker);
    document.getElementById('saveAs').addEventListener('click', saveAsPicker);
    document.getElementById('refreshList').addEventListener('click', listEntries);

    // Init
    if (!fsSupported()) {
      log('Browser tidak mendukung File System Access API. Coba Chrome/Edge terbaru.', true);
      document.querySelectorAll('#controls button').forEach(b => b.disabled = true);
    } else {
      log('API tersedia. Klik ‚ÄúPilih Folder‚Äù untuk mulai.');
    }

    // Sisipkan snippet kamu ke iframe sandbox
    const raw = document.getElementById('user-snippet-raw').value;
    document.getElementById('user-sandbox').srcdoc = raw;
  </script>
</body>
</html>
