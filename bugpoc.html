<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>V8 Infinite JIT + iframe + GC Fuzz</title>
</head>
<body>
<h1>V8 ThreadIsolation / Infinite Fuzz</h1>
<p>Biarkan tab ini jalan.</p>

<script>
/* ================= helpers ================= */

function makeJitFunctions(n) {
  const arr = [];
  for (let i = 0; i < n; i++) {
    arr.push(new Function("x", "return x + 1;"));
  }
  return arr;
}

function hotRun(funcs, rounds) {
  let x = 0;
  for (let r = 0; r < rounds; r++) {
    for (let f of funcs) x = f(x);
  }
  return x;
}

function compileWasm() {
  const wasmBytes = new Uint8Array([
    0x00,0x61,0x73,0x6d,
    0x01,0x00,0x00,0x00
  ]);
  return WebAssembly.compile(wasmBytes).catch(() => {});
}

/* ================= iframe srcdoc ================= */

function iframeHTML() {
  return `
<!DOCTYPE html>
<html>
<body>
<script>
  // HTMLDocumentParser + tokenizer pressure
  for (let i = 0; i < 5000; i++) {
    const d = document.createElement("div");
    d.textContent = "tok-" + i;
    document.body.appendChild(d);
  }

  function spam() {
    let arr = [];
    for (let i = 0; i < 2000; i++) {
      arr.push(new Function("y", "return y * 2;"));
    }
    let v = 1;
    for (let r = 0; r < 30; r++) {
      for (let f of arr) v = f(v);
    }
    arr = null;
    if (parent.gc) parent.gc();
  }

  setInterval(spam, 5);
<\/script>
</body>
</html>`;
}

/* ================= PHASE 1: YouTube iframe ================= */

const yt = document.createElement("iframe");
yt.width = "560";
yt.height = "315";
yt.src =
  "https://www.youtube.com/embed/i5p51UDoW0U?list=RDi5p51UDoW0U&autoplay=1";
yt.allow =
  "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
yt.allowFullscreen = true;
document.body.appendChild(yt);

/* ================= PHASE 2: tokenizer iframe ================= */

const warmupIframe = document.createElement("iframe");
warmupIframe.srcdoc = iframeHTML();
document.body.appendChild(warmupIframe);

/* ================= PHASE 3: delay ================= */

setTimeout(() => {
  console.log("[*] starting INFINITE fuzz");
  infiniteFuzz();
}, 3000);

/* ================= PHASE 4: infinite fuzz ================= */

async function infiniteFuzz() {
  let iter = 0;

  while (true) {
    // ---- main doc JIT ----
    let funcs = makeJitFunctions(3000);
    hotRun(funcs, 20);
    funcs = null;

    await compileWasm();

    if (typeof gc === "function") gc();

    // ---- churn iframe ----
    let iframe = document.createElement("iframe");
    iframe.srcdoc = iframeHTML();
    document.body.appendChild(iframe);

    await new Promise(r => setTimeout(r, 10));

    iframe.remove();
    iframe = null;

    if (typeof gc === "function") gc();

    if ((++iter % 50) === 0) {
      console.log("[*] iter", iter);
    }

    // kasih napas kecil â†’ biar parallel sweeper & thread pool hidup
    await new Promise(r => setTimeout(r, 1));
  }
}
</script>
</body>
</html>
