<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>V8 JIT / ThreadIsolation Stress</title>
</head>
<body>
<h1>V8 JIT Stress Test</h1>
<p>Buka DevTools Console. Biarkan halaman ini berjalan.</p>

<script>
/*
  Target:
  - Memicu banyak alokasi executable memory (JIT)
  - Memicu optimisasi / deoptimisasi
  - Memicu GC + sweeper parallel
*/

// 1) Banyak function dinamis → JIT allocations
function makeJitFunctions(count) {
  const arr = [];
  for (let i = 0; i < count; i++) {
    arr.push(new Function("x", "return x + 1;"));
  }
  return arr;
}

// 2) Hot loop → paksa optimize
function hotLoop(funcs, rounds) {
  let x = 0;
  for (let r = 0; r < rounds; r++) {
    for (let f of funcs) {
      x = f(x);
    }
  }
  return x;
}

// 3) WASM minimal → executable memory tambahan
function compileWasm() {
  // wasm module kosong (valid minimal)
  const wasmBytes = new Uint8Array([
    0x00,0x61,0x73,0x6d, // magic
    0x01,0x00,0x00,0x00  // version
  ]);
  return WebAssembly.compile(wasmBytes).catch(() => {});
}

// 4) Loop stress utama
(async function stress() {
  console.log("[*] starting stress");

  for (let iter = 0; iter < 1000; iter++) {
    // Buat & buang banyak fungsi
    let funcs = makeJitFunctions(2000);
    hotLoop(funcs, 20);

    // Drop reference → eligible for GC
    funcs = null;

    // WASM compile (kadang memicu JIT allocator)
    await compileWasm();

    // Paksa GC kalau tersedia
    if (typeof gc === "function") {
      gc();
    }

    if (iter % 10 === 0) {
      console.log("[*] iter", iter);
    }
  }

  console.log("[*] done");
})();
</script>
</body>
</html>
