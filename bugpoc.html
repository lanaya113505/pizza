<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>V8 JIT + iframe + GC Stress</title>
</head>
<body>
<h1>V8 ThreadIsolation / JIT Stress (iframe)</h1>
<p>Buka DevTools Console dan biarkan jalan.</p>

<script>
/* ================= helpers ================= */

function makeJitFunctions(n) {
  const arr = [];
  for (let i = 0; i < n; i++) {
    arr.push(new Function("x", "return x + 1;"));
  }
  return arr;
}

function hotRun(funcs, rounds) {
  let x = 0;
  for (let r = 0; r < rounds; r++) {
    for (let f of funcs) x = f(x);
  }
  return x;
}

function compileWasm() {
  const wasmBytes = new Uint8Array([
    0x00,0x61,0x73,0x6d,
    0x01,0x00,0x00,0x00
  ]);
  return WebAssembly.compile(wasmBytes).catch(() => {});
}

/* ================= iframe payload ================= */

function iframeHTML() {
  return `
<!DOCTYPE html>
<html>
<body>
<script>
  // parser + tokenizer pressure
  for (let i = 0; i < 3000; i++) {
    const d = document.createElement("div");
    d.textContent = i;
    document.body.appendChild(d);
  }

  function spam() {
    let arr = [];
    for (let i = 0; i < 1500; i++) {
      arr.push(new Function("y", "return y * 2;"));
    }
    let v = 1;
    for (let r = 0; r < 20; r++) {
      for (let f of arr) v = f(v);
    }
    arr = null;
    if (parent.gc) parent.gc();
  }

  setInterval(spam, 10);
<\/script>
</body>
</html>`;
}

/* ================= phase 1: iframe render ================= */

console.log("[1] create warm-up iframe");

let warmupIframe = document.createElement("iframe");
warmupIframe.srcdoc = iframeHTML();
document.body.appendChild(warmupIframe);

warmupIframe.onload = () => {
  console.log("[2] iframe loaded → tokenizer active");
};

/* ================= phase 2: delay ================= */

setTimeout(() => {
  console.log("[3] starting fuzz AFTER iframe render");

  stress();   // ⬅️ fuzz baru jalan di sini

}, 2000); // ⏱️ ubah: 1000 / 2000 / 5000 ms

/* ================= phase 3: fuzz ================= */

async function stress() {
  for (let i = 0; i < 500; i++) {

    // --- main document JIT ---
    let funcs = makeJitFunctions(2000);
    hotRun(funcs, 15);
    funcs = null;

    await compileWasm();

    if (typeof gc === "function") gc();

    // --- churn iframe ---
    let iframe = document.createElement("iframe");
    iframe.srcdoc = iframeHTML();
    document.body.appendChild(iframe);

    await new Promise(r => setTimeout(r, 20));

    iframe.remove();
    iframe = null;

    if (typeof gc === "function") gc();

    if (i % 10 === 0) {
      console.log("[*] iter", i);
    }
  }

  console.log("[*] stress finished");
}
</script>
</body>
</html>
