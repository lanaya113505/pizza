<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QuotaManager Fuzzing</title>
  <style>
    body { font-family: sans-serif; background: #111; color: #0f0; padding: 1em; }
    h1 { color: #0f0; }
    p { color: #aaa; }
  </style>
</head>
<body>
  <h1>QuotaManager Stress Test</h1>
  <p>Script sedang berjalan. Lihat console (F12) untuk log dan error.</p>

  <script>
    const storageSize = 10 * 1024 * 1024; // 10MB
    const fileCount = 50; // banyak file sekaligus

    function randomFileName() {
      return 'quota_fuzz_' + Math.random().toString(36).substr(2, 8) + '.txt';
    }

    function writeBigFile(fs, size = 1024 * 1024) {
      const fileName = randomFileName();
      fs.root.getFile(fileName, { create: true }, fileEntry => {
        fileEntry.createWriter(writer => {
          const bigBlob = new Blob([new Uint8Array(size)], { type: 'application/octet-stream' });

          writer.onwriteend = () => {
            console.log('Wrote large file:', fileName);
            setTimeout(() => {
              fileEntry.remove(
                () => console.log('Deleted:', fileName),
                err => console.warn('Failed to delete:', fileName, err)
              );
            }, 0);
          };

          writer.onerror = err => {
            console.error('Error writing:', fileName, err);
          };

          writer.write(bigBlob);
        }, err => {
          console.error('CreateWriter failed:', fileName, err);
        });
      }, err => {
        console.error('GetFile failed:', fileName, err);
      });
    }

    window.onload = () => {
      if (!window.webkitRequestFileSystem) {
        console.error("FileSystem API not supported in this browser.");
        document.body.innerHTML += "<p style='color: red;'>Browser tidak mendukung FileSystem API.</p>";
        return;
      }

      webkitRequestFileSystem(window.PERSISTENT, storageSize, fs => {
        console.log('Starting QuotaManager stress test...');
        setInterval(() => {
          for (let i = 0; i < fileCount; i++) {
            const randomSize = Math.floor(Math.random() * 5 * 1024 * 1024); // up to 5MB
            writeBigFile(fs, randomSize);
          }
        }, 1000);
      }, err => {
        console.error('Failed to initialize FileSystem:', err);
        document.body.innerHTML += `<p style='color:red;'>Gagal akses FileSystem: ${err.message}</p>`;
      });
    };
  </script>
</body>
</html>
