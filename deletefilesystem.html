<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fuzz FileSystem + Rendering + getDisplayMedia</title>
  <style>
    body { background: #000; color: #0f0; font-family: monospace; }
    .box {
      width: 100px;
      height: 100px;
      background: red;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: spin 0.1s linear infinite;
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
  </style>
</head>
<body>
  <h1>Fuzzing Chromium</h1>
  <p id="log">Memulai...</p>
  <div class="box"></div>
  <script>
    const log = msg => {
      console.log(msg);
      document.getElementById("log").innerText = msg;
    };

    const randomFileName = () => 'fuzz_' + Math.random().toString(36).substr(2, 6) + '.txt';

    async function triggerGetDisplayMedia() {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video: { preferCurrentTab: true },
          audio: false
        });
        log("Screen sharing ON");
        const video = document.createElement("video");
        video.srcObject = stream;
        video.autoplay = true;
        video.muted = true;
        document.body.appendChild(video);
      } catch (e) {
        log("Failed screen share: " + e.message);
      }
    }

    function stressFileSystem(fs) {
      const iterations = 100;
      const maxSize = 4 * 1024 * 1024; // 4MB
      for (let i = 0; i < iterations; i++) {
        const fileName = randomFileName();
        fs.root.getFile(fileName, { create: true }, fileEntry => {
          fileEntry.createWriter(writer => {
            const blob = new Blob([new Uint8Array(maxSize)], { type: 'binary/octet-stream' });
            writer.write(blob);

            // Delete right after write
            writer.onwriteend = () => {
              fileEntry.remove(() => {}, () => {});
            };
          }, () => {});
        }, () => {});
      }
    }

    window.onload = () => {
      if (!window.webkitRequestFileSystem) {
        log("FileSystem API not supported");
        return;
      }

      triggerGetDisplayMedia(); // screen share
      webkitRequestFileSystem(window.PERSISTENT, 1024 * 1024 * 100, fs => {
        log("Fuzzing FS + screen + render...");
        setInterval(() => stressFileSystem(fs), 100);
      }, e => {
        log("Failed FS: " + e.message);
      });
    };
  </script>
</body>
</html>
