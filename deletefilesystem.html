<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QuotaManager Fuzzer</title>
  <style>
    body { background: black; color: lime; font-family: monospace; padding: 1em; }
    h1 { color: lime; }
    p { color: gray; }
  </style>
</head>
<body>
  <h1>QuotaManager Fuzzing Enhanced</h1>
  <p>Open devtools (F12) for fuzz logs.</p>

  <script>
    const storageSize = 20 * 1024 * 1024; // 20MB
    const fileCount = 100; // agresif

    function randomFileName() {
      return 'fuzz_' + Math.random().toString(36).substring(2, 8) + '.txt';
    }

    function writeFuzzFile(fs, size = 1024 * 1024) {
      const fileName = randomFileName();

      fs.root.getFile(fileName, { create: true }, fileEntry => {
        fileEntry.createWriter(writer => {
          const buffer = new Uint8Array(size);
          crypto.getRandomValues(buffer); // entropy
          const blob = new Blob([buffer], { type: 'application/octet-stream' });
          const url = URL.createObjectURL(blob);

          // Optional blob leak
          if (Math.random() < 0.2) {
            console.log("Blob URL created:", url); // never revoked
          }

          writer.onwriteend = () => {
            // Try truncate and remove at once
            if (Math.random() < 0.5) {
              writer.truncate(0);
              console.log('Truncated:', fileName);
            }

            // Random GC (if exposed via --js-flags="--expose-gc")
            if (typeof gc === "function" && Math.random() < 0.3) {
              console.log("Triggering GC()");
              gc();
            }

            setTimeout(() => {
              fileEntry.remove(
                () => console.log('Deleted:', fileName),
                err => console.warn('Failed delete:', fileName, err)
              );
            }, Math.random() * 100); // possible race
          };

          writer.onerror = err => {
            console.error('Write error:', fileName, err);
          };

          try {
            writer.write(blob);
          } catch (e) {
            console.error('Write threw exception:', e);
          }
        }, err => {
          console.error('CreateWriter failed:', fileName, err);
        });
      }, err => {
        console.error('GetFile failed:', fileName, err);
      });
    }

    window.onload = () => {
      if (!window.webkitRequestFileSystem) {
        document.body.innerHTML += "<p style='color:red;'>Browser tidak support FileSystem API.</p>";
        return;
      }

      webkitRequestFileSystem(window.PERSISTENT, storageSize, fs => {
        console.log('Starting aggressive fuzzing...');
        setInterval(() => {
          for (let i = 0; i < fileCount; i++) {
            const randSize = 1 + Math.floor(Math.random() * 5 * 1024 * 1024); // up to 5MB
            writeFuzzFile(fs, randSize);
          }
        }, 800); // sedikit lebih cepat
      }, err => {
        console.error('Init error:', err);
      });
    };
  </script>
</body>
</html>
